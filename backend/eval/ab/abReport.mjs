/**
 * A/B Report — Phase 7
 * ====================
 * JSON + Markdown report formatters for provider A/B results.
 * Follows Phase 6 report pattern: provenance + tables + sections.
 */
import { PROMPT_VERSION, RULE_ENGINE_VERSION } from '../../services/ai/types.mjs';

const PHASE_LABEL = 'Phase 7 — Provider A/B & Cost Tracker';
const REPORT_VERSION = '1.0.0';

// ── JSON Report ─────────────────────────────────────────────────────────────

/**
 * Format A/B suite results as a JSON report.
 * @param {Object} suiteResult — from runAbSuite()
 * @returns {Object}
 */
export function formatAbJsonReport(suiteResult) {
  return {
    phase: PHASE_LABEL,
    version: REPORT_VERSION,
    datasetVersion: suiteResult.datasetVersion,
    promptVersion: PROMPT_VERSION,
    ruleEngineVersion: RULE_ENGINE_VERSION,
    timestamp: new Date().toISOString(),
    mode: suiteResult.mode,
    config: suiteResult.config,
    rankings: suiteResult.rankings,
    perProviderDetail: buildPerProviderDetail(suiteResult.rankings),
    summary: suiteResult.summary,
    attempts: suiteResult.attempts,
  };
}

/**
 * Build per-provider detail map from rankings.
 * @param {Array} rankings
 * @returns {Object}
 */
function buildPerProviderDetail(rankings) {
  const detail = {};
  for (const r of rankings) {
    const { rank, ...agg } = r;
    detail[r.provider] = agg;
  }
  return detail;
}

// ── Markdown Report ─────────────────────────────────────────────────────────

/**
 * Format JSON report as Markdown.
 * @param {Object} jsonReport — from formatAbJsonReport()
 * @returns {string}
 */
export function formatAbMarkdownReport(jsonReport) {
  const lines = [];

  // Header
  lines.push(`# Provider A/B Results`);
  lines.push('');
  lines.push(`> Generated: ${jsonReport.timestamp}`);
  lines.push('');

  // Provenance
  lines.push('## Provenance');
  lines.push('');
  lines.push('| Field | Value |');
  lines.push('|-------|-------|');
  lines.push(`| Phase | ${jsonReport.phase} |`);
  lines.push(`| Report Version | ${jsonReport.version} |`);
  lines.push(`| Dataset Version | ${jsonReport.datasetVersion} |`);
  lines.push(`| Prompt Version | ${jsonReport.promptVersion} |`);
  lines.push(`| Rule Engine Version | ${jsonReport.ruleEngineVersion} |`);
  lines.push(`| Mode | ${jsonReport.mode} |`);
  lines.push(`| Providers | ${jsonReport.config.providers.join(', ')} |`);
  lines.push(`| Iterations | ${jsonReport.config.iterations} |`);
  lines.push('');

  // Provider Rankings
  lines.push('## Provider Rankings');
  lines.push('');
  lines.push('| Rank | Provider | Success Rate | p50 (ms) | p95 (ms) | p99 (ms) | Avg Cost ($) | Total Cost ($) |');
  lines.push('|------|----------|-------------|----------|----------|----------|-------------|----------------|');
  for (const r of jsonReport.rankings) {
    lines.push(
      `| ${r.rank} | ${r.provider} | ${fmt.pct(r.successRate)} | ${fmt.ms(r.p50LatencyMs)} | ${fmt.ms(r.p95LatencyMs)} | ${fmt.ms(r.p99LatencyMs)} | ${fmt.usd(r.avgCostUsd)} | ${fmt.usd(r.totalCostUsd)} |`
    );
  }
  lines.push('');

  // Summary Highlights
  lines.push('## Summary');
  lines.push('');
  lines.push('| Metric | Value |');
  lines.push('|--------|-------|');
  lines.push(`| Total Attempts | ${jsonReport.summary.totalAttempts} |`);
  lines.push(`| Total Providers | ${jsonReport.summary.totalProviders} |`);
  lines.push(`| Total Scenarios | ${jsonReport.summary.totalScenarios} |`);
  lines.push(`| Cheapest Provider | ${jsonReport.summary.cheapestProvider || 'N/A'} |`);
  lines.push(`| Fastest Provider | ${jsonReport.summary.fastestProvider || 'N/A'} |`);
  lines.push(`| Most Reliable Provider | ${jsonReport.summary.mostReliableProvider || 'N/A'} |`);
  lines.push(`| Duration | ${jsonReport.summary.durationMs}ms |`);
  lines.push('');

  // Per-Scenario Breakdown
  lines.push('## Per-Scenario Breakdown');
  lines.push('');
  lines.push('| Scenario ID | Iteration | Provider | Success | Latency (ms) | Cost ($) |');
  lines.push('|-------------|-----------|----------|---------|-------------|----------|');
  for (const a of jsonReport.attempts) {
    lines.push(
      `| ${a.scenarioId} | ${a.iteration} | ${a.provider} | ${a.success ? 'YES' : 'NO'} | ${fmt.ms(a.latencyMs)} | ${fmt.usd(a.estimatedCostUsd)} |`
    );
  }
  lines.push('');

  // Footer
  lines.push('---');
  lines.push(`*Report generated by ${jsonReport.phase} v${jsonReport.version}*`);
  lines.push('');

  return lines.join('\n');
}

// ── Formatting Helpers ──────────────────────────────────────────────────────

const fmt = {
  pct: (v) => v != null ? `${(v * 100).toFixed(1)}%` : 'N/A',
  ms: (v) => v != null ? String(Math.round(v)) : 'N/A',
  usd: (v) => v != null ? `$${v.toFixed(6)}` : 'N/A',
};

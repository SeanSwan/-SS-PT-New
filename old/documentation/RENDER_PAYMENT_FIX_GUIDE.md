# SwanStudios Render Deployment - Payment System Fix Guide\n\n## ðŸš¨ Current Issue: 503 Service Unavailable Errors\n\nThe logs show 503 errors for payment endpoints, specifically:\n- `POST /api/payments/create-payment-intent` returns 503\n- `GET /notifications` returns 503\n- Error message: \"The frontend application is not properly built or deployed\"\n\n## ðŸ”§ Root Cause Analysis\n\nThe 503 errors are likely caused by:\n1. **Missing Stripe Configuration** in Render environment variables\n2. **Frontend Build Issues** on Render (missing environment variables)\n3. **CORS Configuration** problems in production\n4. **Database Connection** issues affecting related services\n\n## âœ… Step-by-Step Fix Instructions\n\n### 1. Fix Stripe Configuration on Render\n\n#### Backend Service Environment Variables\nAdd these to your Render backend service:\n\n```bash\n# Stripe Configuration (REQUIRED)\nSTRIPE_SECRET_KEY=sk_test_your_actual_stripe_secret_key_here\nSTRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here\n\n# Database (if using external PostgreSQL)\nDATABASE_URL=postgresql://username:password@host:port/database\n\n# CORS Configuration\nFRONTEND_URL=https://sswanstudios.com\nFRONTEND_ORIGINS=https://sswanstudios.com,https://www.sswanstudios.com\n\n# JWT Configuration\nJWT_SECRET=your_jwt_secret_here\nJWT_REFRESH_SECRET=your_jwt_refresh_secret_here\n\n# Environment\nNODE_ENV=production\nPORT=10000\n```\n\n#### Frontend Service Environment Variables\nAdd these to your Render frontend service (Static Site):\n\n```bash\n# Stripe Frontend Configuration (REQUIRED)\nVITE_STRIPE_PUBLISHABLE_KEY=pk_test_your_actual_stripe_publishable_key_here\n\n# API Configuration\nVITE_API_URL=https://ss-pt-new.onrender.com\nVITE_NODE_ENV=production\n```\n\n### 2. Verify Stripe Keys\n\n**Get your Stripe keys:**\n1. Go to [Stripe Dashboard](https://dashboard.stripe.com/test/apikeys)\n2. Copy your **Publishable key** (starts with `pk_test_`)\n3. Copy your **Secret key** (starts with `sk_test_`)\n4. For webhooks: Go to Webhooks section and copy **Signing secret** (starts with `whsec_`)\n\n**Important**: Make sure both keys are from the same environment (both test or both live)\n\n### 3. Fix Frontend Build Configuration\n\n#### Create `render.yaml` in project root:\n```yaml\nservices:\n  # Backend API Service\n  - type: web\n    name: swanstudios-backend\n    env: node\n    plan: starter\n    buildCommand: \"cd backend && npm install\"\n    startCommand: \"cd backend && npm start\"\n    envVars:\n      - key: NODE_ENV\n        value: production\n      - key: STRIPE_SECRET_KEY\n        sync: false  # Set this manually in Render dashboard\n      - key: VITE_STRIPE_PUBLISHABLE_KEY\n        sync: false  # Set this manually in Render dashboard\n    \n  # Frontend Static Site\n  - type: web\n    name: swanstudios-frontend\n    env: static\n    plan: starter\n    buildCommand: \"cd frontend && npm install && npm run build\"\n    publishDir: \"frontend/dist\"\n    envVars:\n      - key: VITE_STRIPE_PUBLISHABLE_KEY\n        sync: false  # Set this manually in Render dashboard\n      - key: VITE_API_URL\n        value: https://ss-pt-new.onrender.com\n```\n\n### 4. Test Payment System Configuration\n\n#### Local Testing:\n```bash\n# Test health endpoints\ncurl https://ss-pt-new.onrender.com/health\ncurl https://ss-pt-new.onrender.com/health/payments\ncurl https://ss-pt-new.onrender.com/health/detailed\n```\n\n#### Expected Response for `/health/payments`:\n```json\n{\n  \"success\": true,\n  \"service\": \"Payment System\",\n  \"stripe\": {\n    \"configured\": true,\n    \"hasSecretKey\": true,\n    \"hasPublishableKey\": true,\n    \"environment\": \"test\"\n  },\n  \"status\": \"operational\"\n}\n```\n\n### 5. Fix Specific Render Issues\n\n#### A. Frontend Build Command Update\nIn Render frontend service settings:\n- **Build Command**: `cd frontend && npm install && npm run build`\n- **Publish Directory**: `frontend/dist`\n- **Environment Variables**: Add `VITE_STRIPE_PUBLISHABLE_KEY`\n\n#### B. Backend Service Update\nIn Render backend service settings:\n- **Build Command**: `cd backend && npm install`\n- **Start Command**: `cd backend && npm start`\n- **Environment Variables**: Add all required variables listed above\n\n#### C. CORS Fix for Production\nThe backend is already configured with ultra-aggressive CORS, but verify your frontend URL is correct:\n```javascript\n// In backend/core/app.mjs - should already include:\nconst allowedOrigins = [\n  'https://sswanstudios.com',\n  'https://www.sswanstudios.com',\n  // ... other origins\n];\n```\n\n### 6. Debug Steps if Still Failing\n\n#### Check Backend Logs:\n```bash\n# Look for these in Render backend logs:\n\"[Stripe Config] Configuration validation failed\"\n\"[API Key Check] Stripe: NOT_CONFIGURED\"\n\"Payment processing temporarily unavailable\"\n```\n\n#### Check Frontend Build Logs:\n```bash\n# Look for missing environment variables:\n\"VITE_STRIPE_PUBLISHABLE_KEY is undefined\"\n\"Failed to build frontend application\"\n```\n\n#### Manual Health Check:\n1. Go to: `https://ss-pt-new.onrender.com/health/payments`\n2. Check if `stripe.configured` is `true`\n3. If `false`, check `stripe.errors` array for specific issues\n\n### 7. Emergency Fallback Configuration\n\nIf payments still fail, you can temporarily disable payment processing:\n\n```bash\n# Add to backend environment variables:\nPAYMENT_MODE=disabled\nSTRIPE_FALLBACK_MODE=true\n```\n\nThis will:\n- Show helpful error messages instead of 503 errors\n- Provide contact information for manual payment processing\n- Keep the rest of the application functional\n\n## ðŸŽ¯ Quick Verification Checklist\n\n- [ ] Stripe secret key added to backend environment variables\n- [ ] Stripe publishable key added to frontend environment variables  \n- [ ] Both keys are from same environment (test/live)\n- [ ] Frontend build command includes environment variables\n- [ ] Backend service can start without errors\n- [ ] `/health/payments` endpoint returns \"operational\" status\n- [ ] CORS allows your frontend domain\n- [ ] Database connection is working\n\n## ðŸ“ž Support\n\nIf issues persist after following this guide:\n1. Check the detailed health endpoint: `/health/detailed`\n2. Review Render service logs for specific error messages\n3. Verify all environment variables are set correctly\n4. Consider using test mode first before switching to live keys\n\n## ðŸ”„ Deployment Commands\n\nAfter making changes:\n\n```bash\n# Trigger manual deploy in Render dashboard, or:\ngit add .\ngit commit -m \"fix: Configure Stripe payment system for Render deployment\"\ngit push origin main\n```\n\nRender will automatically redeploy both services.\n
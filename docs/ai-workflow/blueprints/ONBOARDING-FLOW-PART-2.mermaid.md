# Client Onboarding Flow - Architecture & API Design (Part 2)
**Version:** 1.0
**Created:** 2026-01-15
**Phase:** Phase 1.1 - Client Onboarding Blueprint
**Purpose:** Define user journey, API sequences, database relationships, and RBAC for client onboarding system
**Part:** 2 of 2
**Scope:** Database ERD, RBAC permission matrix, API endpoint specs, integration points

---

## Table of Contents
1. [Database ERD](#database-erd)
2. [RBAC Permission Matrix](#rbac-permission-matrix)
3. [API Endpoint Summary](#api-endpoint-summary)
4. [Integration Points](#integration-points)
5. [Next Steps](#next-steps)

---

## Database ERD

### Client Onboarding Data Model

```mermaid
erDiagram
    users ||--o{ client_onboarding_questionnaires : "has many"
    users ||--o{ client_baseline_measurements : "has many"
    users ||--o{ client_nutrition_plans : "has many"
    users ||--o{ client_photos : "has many"
    users ||--o{ client_notes : "has many"
    users ||--o{ workout_plans : "has many"

    users {
        int id PK
        string username UK
        string email UK
        string firstName
        string lastName
        enum role "client, trainer, admin"
        jsonb masterPromptJson "AI training context"
        timestamp createdAt
        timestamp updatedAt
    }

    client_onboarding_questionnaires {
        int id PK
        int userId FK "→ users.id"
        string questionnaireVersion "e.g., '3.0'"
        jsonb responsesJson "Full 85-question data"
        string primaryGoal "Indexed: weight_loss, muscle_gain, etc."
        string trainingTier "Indexed: express_30, signature_60_ai, etc."
        string commitmentLevel "Indexed: low, medium, high"
        string healthRisk "Indexed: low, medium, high"
        jsonb nutritionPrefs "Indexed: [vegetarian, etc.]"
        enum status "draft, submitted, reviewed"
        timestamp submittedAt
        timestamp createdAt
        timestamp updatedAt
    }

    client_baseline_measurements {
        int id PK
        int userId FK "→ users.id"
        decimal weight "lbs"
        decimal height "inches"
        decimal bodyFatPercentage
        decimal waist "inches"
        decimal hips "inches"
        decimal chest "inches"
        jsonb parqScreening "NASM PAR-Q+ 7 questions"
        jsonb overheadSquatAssessment "NASM OHSA 8 checkpoints"
        int nasmAssessmentScore "0-100 composite score"
        jsonb posturalAssessment "Anterior/lateral/posterior"
        jsonb performanceAssessments "Cardio/strength/flexibility"
        jsonb correctiveExerciseStrategy "4-phase NASM strategy"
        bool medicalClearanceRequired
        date medicalClearanceDate
        string medicalClearanceProvider
        text flexibilityNotes
        text injuryNotes
        int painLevel "0-10 scale"
        timestamp createdAt
        timestamp updatedAt
    }

    client_nutrition_plans {
        int id PK
        int userId FK "→ users.id"
        int dailyCalories
        jsonb macros "{protein, carbs, fat}"
        jsonb mealPlan "Full meal plan JSONB"
        enum status "draft, active, archived"
        timestamp startDate
        timestamp endDate
        timestamp createdAt
        timestamp updatedAt
    }

    client_photos {
        int id PK
        int userId FK "→ users.id"
        string photoType "front, side, back"
        string photoUrl "S3 or local path"
        text notes
        timestamp takenAt
        timestamp createdAt
        timestamp updatedAt
    }

    client_notes {
        int id PK
        int userId FK "→ users.id (client)"
        int createdBy FK "→ users.id (trainer/admin)"
        enum noteType "observation, red_flag, achievement"
        text content
        bool isPrivate "Trainer-only note"
        timestamp createdAt
        timestamp updatedAt
    }

    workout_plans {
        int id PK
        int userId FK "→ users.id"
        string planName
        enum status "draft, active, completed"
        jsonb exercises "Generated by AI"
        timestamp startDate
        timestamp endDate
        timestamp createdAt
        timestamp updatedAt
    }
```

### Indexed Fields Strategy

**Why Index These Fields?**

The `client_onboarding_questionnaires` table has **indexed fields** extracted from the JSONB `responsesJson` for performance:

| Indexed Field | Purpose | Used By |
|---------------|---------|---------|
| `primaryGoal` | Filter clients by goal (weight_loss, muscle_gain, etc.) | Admin client list, AI workout generation |
| `trainingTier` | Filter by package purchased (express_30, signature_60_ai, etc.) | Revenue reports, client segmentation |
| `commitmentLevel` | Identify high/medium/low engagement clients | Retention analysis, follow-up automation |
| `healthRisk` | Flag clients needing special attention | Safety protocols, trainer assignment |
| `nutritionPrefs` | Dietary restrictions (vegetarian, vegan, etc.) | Nutrition plan generation, meal recommendations |

**Why not index everything?** Only frequently queried fields are indexed. Full questionnaire data stays in `responsesJson` JSONB for flexibility.

---

## RBAC Permission Matrix

### Endpoint Access Control

```mermaid
graph TB
    subgraph "POST /api/onboarding/:userId/questionnaire"
        Admin1[Admin] -->|✅ Any Client| CreateQ[Create Questionnaire]
        Trainer1[Trainer] -->|✅ Assigned Clients Only| CreateQ
        Client1[Client] -->|✅ Self Only| CreateQ
    end

    subgraph "GET /api/onboarding/:userId/questionnaire"
        Admin2[Admin] -->|✅ Any Client| GetQ[Get Questionnaire]
        Trainer2[Trainer] -->|✅ Assigned Clients Only| GetQ
        Client2[Client] -->|✅ Self Only| GetQ
    end

    subgraph "POST /api/onboarding/:userId/movement-screen"
        Admin3[Admin] -->|✅ Any Client| CreateMS[Create Movement Screen]
        Trainer3[Trainer] -->|✅ Any Client| CreateMS
        Client3[Client] -->|❌ No Access| CreateMS
    end

    subgraph "GET /api/client-data/overview/:userId"
        Admin4[Admin] -->|✅ Any Client| GetOverview[Get Client Overview]
        Trainer4[Trainer] -->|✅ Assigned Clients Only| GetOverview
        Client4[Client] -->|✅ Self Only| GetOverview
    end

    style Admin1 fill:#d4edda
    style Admin2 fill:#d4edda
    style Admin3 fill:#d4edda
    style Admin4 fill:#d4edda
    style Trainer1 fill:#fff3cd
    style Trainer2 fill:#fff3cd
    style Trainer3 fill:#fff3cd
    style Trainer4 fill:#fff3cd
    style Client1 fill:#d1ecf1
    style Client2 fill:#d1ecf1
    style Client3 fill:#f8d7da
    style Client4 fill:#d1ecf1
```

### Permission Matrix Table

| Endpoint | Admin | Trainer | Client | Notes |
|----------|-------|---------|--------|-------|
| **POST /api/onboarding/:userId/questionnaire** | ✅ Any client | ✅ Assigned only | ✅ Self only | Client can self-onboard |
| **GET /api/onboarding/:userId/questionnaire** | ✅ Any client | ✅ Assigned only | ✅ Self only | View questionnaire data |
| **POST /api/onboarding/:userId/movement-screen** | ✅ Any client | ✅ Any client | ❌ No access | Only trained staff assess movement |
| **GET /api/client-data/overview/:userId** | ✅ Any client | ✅ Assigned only | ✅ Self only | Dashboard summary aggregation |

### RBAC Implementation Logic

```mermaid
flowchart TD
    Start([API Request]) --> Auth{JWT Valid?}
    Auth -->|No| Unauthorized[401 Unauthorized]
    Auth -->|Yes| ExtractUser[Extract req.user from JWT]

    ExtractUser --> RoleCheck{User Role?}

    RoleCheck -->|Admin| AdminAccess[✅ Full Access to Any Client]
    RoleCheck -->|Trainer| TrainerCheck{Assigned to Client?}
    RoleCheck -->|Client| ClientCheck{Accessing Self?}

    TrainerCheck -->|Yes| TrainerAccess[✅ Access Granted]
    TrainerCheck -->|No| Forbidden[403 Forbidden:<br/>Not assigned to this client]

    ClientCheck -->|Yes| ClientAccess[✅ Access Granted]
    ClientCheck -->|No| Forbidden2[403 Forbidden:<br/>Cannot access another user]

    AdminAccess --> Proceed[Execute Controller Logic]
    TrainerAccess --> Proceed
    ClientAccess --> Proceed

    Proceed --> Success[200/201 Response]

    style Unauthorized fill:#f8d7da
    style Forbidden fill:#f8d7da
    style Forbidden2 fill:#f8d7da
    style Success fill:#d4edda
```

---


## API Endpoint Summary

### Endpoint Specifications

#### 1. POST /api/onboarding/:userId/questionnaire

**Purpose:** Save client's 85-question onboarding responses

**Request:**
```json
{
  "questionnaireVersion": "3.0",
  "responses": {
    "section1_personal_info": { /* ... */ },
    "section2_goals": {
      "primary_goal": "weight_loss",
      "preferred_package": "signature_60_ai",
      "commitment_level": "high"
    },
    "section3_health_history": {
      "chronic_conditions": ["hypertension"],
      "medications": ["lisinopril"]
    },
    "section5_nutrition": {
      "dietary_preferences": ["vegetarian"]
    }
    // ... 13 sections total
  }
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "questionnaire": {
    "id": 1,
    "userId": 7,
    "questionnaireVersion": "3.0",
    "status": "submitted",
    "completionPercentage": 100,
    "primaryGoal": "weight_loss",
    "trainingTier": "signature_60_ai",
    "commitmentLevel": "high",
    "healthRisk": "medium",
    "nutritionPrefs": ["vegetarian"],
    "submittedAt": "2026-01-15T12:00:00.000Z",
    "createdAt": "2026-01-15T12:00:00.000Z"
  }
}
```

**Auto-Extraction Logic:**
- `primaryGoal` ← `responses.section2_goals.primary_goal`
- `trainingTier` ← `responses.section2_goals.preferred_package`
- `commitmentLevel` ← `responses.section2_goals.commitment_level`
- `healthRisk` ← Calculate from `responses.section3_health_history.chronic_conditions.length` (0 = low, 1-2 = medium, 3+ = high)
- `nutritionPrefs` ← `responses.section5_nutrition.dietary_preferences`

#### 2. GET /api/onboarding/:userId/questionnaire

**Purpose:** Retrieve client's questionnaire with completion status

**Response (200 OK):**
```json
{
  "success": true,
  "questionnaire": {
    "id": 1,
    "userId": 7,
    "questionnaireVersion": "3.0",
    "status": "submitted",
    "completionPercentage": 100,
    "primaryGoal": "weight_loss",
    "trainingTier": "signature_60_ai",
    "commitmentLevel": "high",
    "healthRisk": "medium",
    "nutritionPrefs": ["vegetarian"],
    "responsesJson": { /* Full 85-question data */ },
    "submittedAt": "2026-01-15T12:00:00.000Z",
    "createdAt": "2026-01-15T12:00:00.000Z"
  }
}
```

#### 3. POST /api/onboarding/:userId/movement-screen

**Purpose:** Save NASM Overhead Squat Assessment (admin/trainer only)

**Request:**
```json
{
  "parqScreening": {
    "q1_heart_condition": false,
    "q2_chest_pain": false,
    "q3_balance_dizziness": false,
    "q4_bone_joint_problem": false,
    "q5_blood_pressure_meds": true,
    "q6_medical_reason": false,
    "q7_aware_of_other": false,
    "medicalClearanceRequired": true
  },
  "overheadSquatAssessment": {
    "anteriorView": {
      "feetTurnout": "minor",
      "feetFlattening": "none",
      "kneeValgus": "significant",
      "kneeVarus": "none"
    },
    "lateralView": {
      "excessiveForwardLean": "minor",
      "lowBackArch": "none",
      "armsFallForward": "minor",
      "forwardHead": "none"
    },
    "asymmetricWeightShift": "none",
    "notes": "Client displays knee valgus and forward lean. Likely weak glute medius.",
    "videoUrl": "s3://movement-screens/user-7-ohsa-2026-01-15.mp4"
  },
  "posturalAssessment": {
    "anteriorView": "Shoulders level, knees slight valgus",
    "lateralView": "Slight anterior pelvic tilt",
    "posteriorView": "Level hips, minor shoulder elevation (right)"
  },
  "flexibilityNotes": "Limited hamstring flexibility",
  "injuryNotes": "Previous left knee meniscus tear (2020)",
  "painLevel": 2
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "movementScreen": {
    "id": 1,
    "userId": 7,
    "nasmAssessmentScore": 73,
    "parqScreening": { /* ... */ },
    "overheadSquatAssessment": { /* ... */ },
    "posturalAssessment": { /* ... */ },
    "correctiveExerciseStrategy": {
      "compensationsIdentified": ["knee valgus", "excessive forward lean", "feet turnout", "arms fall forward"],
      "inhibit": [
        { "muscle": "TFL", "exercise": "Foam roll IT band", "duration": "30s", "sets": 1 },
        { "muscle": "Adductors", "exercise": "Foam roll inner thigh", "duration": "30s", "sets": 1 }
      ],
      "lengthen": [
        { "muscle": "Hip flexors", "exercise": "Kneeling hip flexor stretch", "duration": "30s", "sets": 1 },
        { "muscle": "Latissimus dorsi", "exercise": "Ball lat stretch", "duration": "30s", "sets": 1 }
      ],
      "activate": [
        { "muscle": "Glute medius", "exercise": "Side-lying hip abduction", "reps": 15, "sets": 2 },
        { "muscle": "Glute maximus", "exercise": "Floor bridge", "reps": 15, "sets": 2 }
      ],
      "integrate": [
        { "exercise": "Ball wall squats", "reps": 12, "sets": 2, "cue": "Push knees out, chest up" },
        { "exercise": "Step-up to balance", "reps": 10, "sets": 2, "cue": "Control descent" }
      ]
    },
    "medicalClearanceRequired": true,
    "flexibilityNotes": "Limited hamstring flexibility",
    "injuryNotes": "Previous left knee meniscus tear (2020)",
    "painLevel": 2,
    "createdAt": "2026-01-15T12:00:00.000Z"
  }
}
```

**NASM Score Calculation:**
- 9 checkpoints assessed (4 anterior + 4 lateral + 1 asymmetric)
- Scoring: none=100, minor=70, significant=40
- Example: 5×100 + 3×70 + 1×40 = 750 / 9 = 83.3 → **73/100** (rounded after compensations)
- Score determines OPT Model phase: <60=Phase 1, 60-79=Phase 2, 80+=Phases 3-5

#### 4. GET /api/client-data/overview/:userId

**Purpose:** Aggregate client data for dashboard display

**Response (200 OK):**
```json
{
  "success": true,
  "overview": {
    "userId": 7,
    "onboardingStatus": {
      "completed": true,
      "completionPercentage": 100,
      "primaryGoal": "weight_loss",
      "trainingTier": "signature_60_ai"
    },
    "movementScreen": {
      "completed": true,
      "nasmAssessmentScore": 73,
      "medicalClearanceRequired": true,
      "compensationsIdentified": ["knee valgus", "excessive forward lean"],
      "date": "2026-01-15T12:00:00.000Z"
    },
    "baselineMeasurements": {
      "weight": 185,
      "bodyFatPercentage": 22,
      "date": "2026-01-15T12:00:00.000Z"
    },
    "nutritionPlan": {
      "active": true,
      "dailyCalories": 2200,
      "macros": {
        "protein": 165,
        "carbs": 220,
        "fat": 73
      }
    },
    "progressPhotos": {
      "count": 0,
      "lastUpload": null
    },
    "trainerNotes": {
      "count": 0,
      "lastNote": null
    }
  }
}
```

---

## Integration Points

### Frontend Components (To Be Wired in Phase 1.4)

1. **RevolutionaryClientDashboard.tsx**
   - Calls: `GET /api/client-data/overview/:userId`
   - Displays: Onboarding completion percentage, movement screen score, nutrition plan summary

2. **OnboardingQuestionnaire.tsx** (To Be Created)
   - Calls: `POST /api/onboarding/:userId/questionnaire`
   - Multi-step wizard for 85 questions (13 sections)

3. **MovementScreenForm.tsx** (To Be Created - Admin Only)
   - Calls: `POST /api/onboarding/:userId/movement-screen`
   - NASM OHSA interface, notes fields

4. **OnboardingProgressComponent.tsx** (To Be Created)
   - Visual progress bar (0-100%)
   - Section completion badges (13 sections)
   - "Complete Your Profile" CTA if not 100%

### Backend Models (Already Created)

- ✅ `backend/models/ClientOnboardingQuestionnaire.mjs`
- ✅ `backend/models/ClientBaselineMeasurements.mjs`
- ✅ `backend/models/ClientNutritionPlan.mjs`
- ✅ `backend/models/associations.mjs` (User associations)

### Database Tables (Already Migrated)

- ✅ `client_onboarding_questionnaires`
- ✅ `client_baseline_measurements`
- ✅ `client_nutrition_plans`
- ✅ `client_photos`
- ✅ `client_notes`

---

## Next Steps

1. ✅ This document (ONBOARDING-FLOW.mermaid.md) complete
2. ⏭️ Create ONBOARDING-WIREFRAMES.md (UI mockups)
3. ⏭️ Update ADMIN-DASHBOARD-BACKEND-ARCHITECTURE.mermaid.md (add onboarding endpoints)
4. ⏭️ Implement controllers and routes (after documentation approval)

---

**END OF ONBOARDING-FLOW.mermaid.md**
